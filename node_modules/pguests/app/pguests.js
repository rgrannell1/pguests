
"use strict"





const constants  = require('pguests/commons/constants')
const report     = require('pguests/reporters/report')
const packetData = require('pguests/network/packet-data')





const pguests = rawArgs => {

	const args  = pguests.preprocess(rawArgs)
	const pconn = packetData( )
	const state = {
		received: [ ]
	}


	pconn.on(constants.events.socketStart, socket => {

		state.received.push({
			event: constants.events.socketStart,
			socket
		})

		report(state.received)

	})

	pconn.on(constants.events.socketEnd, socket => {

		state.received.push({
			event: constants.events.socketEnd,
			socket
		})

		report(state.received)

	})

	pconn.on(constants.events.packet, socket => {

	})





	// TODO add live reporters! Otherwise using ev8
	if (args.timeout) {

		setTimeout(( ) => {

			process.exit( )

		}, 1000 * args.timeout)

	}

}




pguests.preprocess = rawArgs => {

	var args = {
		timeout: parseFloat(rawArgs['--timeout'], 10)
	}

	if (!Number.isFinite(args.timeout) || args.timeout < 0) {
		throw Error(`Invalid timeout ${args.timeout}.`)
	}

	return args

}




module.exports = pguests
